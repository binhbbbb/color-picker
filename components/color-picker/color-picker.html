<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../input-picker-pattern/input-picker-pattern.html">
<link rel="import" href="../input-picker-pattern/dropdown-style.html">

<link rel="import" href="../color-input/color-input.html">
<link rel="import" href="color-element.html">

<script>
  /**
   * Mixin for color-picker
   *
   *  @appliesMixin InputPickerPattern
   *  @appliesMixin ColorElementPattern
   *  @appliesMixin ColorInputPattern
   *
   * @mixinFunction
   * @polymer
   */
  const ColorPickerPattern = (superClass) => class extends Polymer.GestureEventListeners(InputPickerPattern(ColorElementPattern(ColorInputPattern(superClass)))) { // eslint-disable-line no-unused-vars, no-undef

    static get expectedNativeInputType() {
      return 'color';
    }

    static get nativeInputBinding() {
      return 'hex';
    }

    static get styleTemplate() {
      return `
        ${super.styleTemplate || ''}
        input.native {
          --input-padding: 0;
          --input-background: transparent;
          --input-focus-background: transparent;
          border-radius: var(--input-border-radius, var(--color-badge-radius, 3px));
          height: var(--color-badge-height, 28px);
          width: var(--color-badge-width, 28px);
        }
        #buttons #colorBadgeContainer {
          position: relative;
          display: inline-flex;
          min-width: var(--color-badge-width, 28px);
          align-self: stretch;
          flex: 1;
          margin-right: var(--input-picker-padding);
        }
        #buttons #colorBadge {
          background: #fff;
          position: relative;
          border-radius: var(--input-icon-border-radius);
          height: 100%;
          width: 100%;
        }
        #formats {
          font-size: 0.9em;
          --inner-input-color: var(--input-picker-color, currentColor);
          margin-right: var(--input-picker-padding);
        }
        ::-webkit-color-swatch {
          border-radius: var(--input-border-radius, var(--color-badge-radius, 3px));
          border: none;
        }
        ::-webkit-color-swatch-wrapper {
          padding: 0;
        }
        ::-moz-color-swatch {
          border-radius: var(--input-border-radius, var(--color-badge-radius, 3px));
          border: none;
        }
      `;
    }

    /**
     * template for native input element
     * @type {string}
     */
    static get nativeInputTemplate() {
      return `
        <template is="dom-if" if="[[native]]" restamp>
          <div id="input">
            ${super.nativeInputTemplate}
            ${this.textInputTemplate}
          </div>
        </template>
      `;
    }

    static get inputTemplate() {
      return `
        <div id="recentColorBadge" class="transparency badge">
          <canvas id="recentColor" width$="[[_recentcolorwidth]]" height$="[[_recentcolorheight]]" on-tap="_resetValues"></canvas>
        </div>
        ${super.inputTemplate}
      `;
    }

    static get buttonTemplate() {
      return `
        <div id="colorBadgeContainer" hidden$="[[autoConfirm]]">
          ${this.colorBadgeTemplate}
        </div>
        <select id="formats" value="{{format::change}}" on-keydown="_stopPropagation">
          <option value="auto">auto</option>
          <option value="rgb">rgb</option>
          <option value="hex">hex</option>
          <option value="hsl">hsl</option>
        </select>
        <div style="flex:1;" hidden$="[[!autoConfirm]]"></div>
        ${super.buttonTemplate || ''}
      `;
    }

    static get pickerTemplate() {
      return `
        <div id="picker" class="dropdown">
          ${this.colorElementTemplate}
        </div>
      `;
    }

    static get properties() {
      return {

        /**
         * the confirmed value
         */
        confirmedValue: {
          type: Object,
          notify: true
        },

        propertyForValue: {
          type: String,
          value: 'colorString'
        },

        _recentcolorheight: Number,

        _recentcolorwidth: Number
      }
    }

    static get observers() {
      return [
        '_confirmedValueChanged(confirmedValue)',
        '_valueChanged(value, autoConfirm)',
        '_computeInvalid(required, confirmedValue)'
      ];
    }

    redraw() {
      super.redraw();
      this._drawBadge(this._badgecontext, this.colorString, this._badgewidth, this._badgeheight);
      this._drawBadge(this._recentcolorcontext, this.propertyForValue === 'colorString' ? this.confirmedValue : this.colorString, this._recentcolorwidth, this._recentcolorheight);
    }

    _resizeBadge() {
      super._resizeBadge();
      if (this._recentcolorcontext === undefined) {
        this._recentcolorcontext = this.$.recentColor.getContext("2d");
      }
      if (this._badgecontext === undefined) {
        this._badgecontext = this.$.badge.getContext("2d");
      }
      const recentcolorRect = this.$.recentColorBadge.getBoundingClientRect();
      this.setProperties({
        _recentcolorwidth: Math.ceil(recentcolorRect.width) || 28,
        _recentcolorheight: Math.ceil(recentcolorRect.height) || 28
      });
    }

    _valueChanged(value) {
      if (value === undefined) {
        this._resetConfirmedValues();
        return; // return, if resseting, so that the picker is not itself resetted
      }
      if (this.autoConfirm || (this._hasNative && this.native)) {
        setTimeout(() => {
          this._setConfirmedValues();
        })
      }
    }

    confirm() {
      super.confirm();
      this._setConfirmedValues();
    }

    cancel() {
      this._resetValues();
      super.cancel();
    }

    validate() {
      this.value = this.confirmedValue;
      return super.validate();
    }

    _confirmedValueChanged(confirmedValue) {
      this._drawBadge(this._recentcolorcontext, this.propertyForValue === 'colorString' ? confirmedValue : this.colorString, this._recentcolorwidth, this._recentcolorheight);
      if (confirmedValue === undefined) {
        this._resetConfirmedValues();
        return;
      }
      this.value = confirmedValue;
    }

    _setConfirmedValues() {
      this.setProperties({
        confirmedValue: this.value
      })
    }

    _resetConfirmedValues() {
      this.setProperties({
        value: undefined,
        confirmedValue: undefined
      })
    }

    _resetValues() {
      this.setProperties({
        value: this.confirmedValue
      })
    }

    open() {
      super.open();
      requestAnimationFrame(() => {
        this.redraw();
      });
    }

    _onDblClick() {
      this._setConfirmedValues();
    }

  }
  window.ColorPickerPattern = ColorPickerPattern;
</script>

<dom-module id="color-picker">
  <script>
  /**
   *  `color-picker` is a picker for color for **[Polymer](https://github.com/Polymer/polymer)** that can use the native input, too. If the **native** picker is choosen and is not supported, this element uses the **polyfill** datetime-picker. The `<calendar-element>` and the `<time-element>` will come in place if the native picker is not available or is not explicitly wanted. The `value` represents the selected `hex-color` and `alpha` the opacity of the color. `css-value` will give you directly the css-string.
   *
   *  ```html
   *    <color-picker value="{{value}}"></color-picker>
   *  ```
   *
   *  Have a look at `<color-element>` and [input-picker-pattern#input-shared-style](https://github.com/fooloomanzoo/input-picker-pattern#input-shared-style) to see the used style-properties.
   *
   *  @polymer
   *  @customElement
   *
   *  @appliesMixin ColorPickerPattern
   *
   *  @demo demo/color-picker.html Color Picker
   *  @demo demo/form.html In A Form
   **/
    class ColorPicker extends ColorPickerPattern(Polymer.Element) { // eslint-disable-line no-undef

      static get is() {
        return 'color-picker';
      }

      get _hasNative() {
        return ColorPicker._hasNative;
      }

      static get styleToInclude() {
        return `${super.styleToInclude || '' } dropdown-style`;
      }
    }

    window.customElements.define(ColorPicker.is, ColorPicker);
  </script>
</dom-module>
