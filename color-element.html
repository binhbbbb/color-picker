<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../input-picker-pattern/input-shared-style.html">
<link rel="import" href="../input-picker-pattern/switch-container-mixin.html">

<link rel="import" href="../color-input/color-input.html">
<link rel="import" href="../color-input/color-text-input.html">
<link rel="import" href="../number-input/number-input.html">
<link rel="import" href="../number-input/integer-input.html">
<link rel="import" href="../text-input/text-input.html">

<script>
  /**
   * Mixin for color-element
   *
   * @appliesMixin ColorInputPattern
   * @appliesMixin SwitchContainerMixin
   *
   * @mixinFunction
   * @polymer
   */
  const ColorElementPattern = superClass => class extends ColorInputPattern(SwitchContainerMixin(superClass)) { // eslint-disable-line no-unused-vars, no-undef

    static get customStyleToInclude() {
      return 'input-shared-style';
    }

    static get customStyleContent() {
      return `
        ${super.customStyleContent || ''}
        #colorElement {
          display: inline-flex;
          flex-direction: column;
          align-items: center;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          -webkit-tap-highlight-color:rgba(0,0,0,0);
          vertical-allign: unset;
          background: var(--input-background);
          color: var(--input-color);
          padding: 4px;
          @apply --input-picker;
          @apply --color-element;
        }
        #colorElement .selectors {
          display: inline-flex;
          flex-direction: row;
        }
        #colorElement .selectors > * {
          position: relative;
          margin: var(--color-element-margin) var(--color-element-margin) var(--color-element-margin) 0;
        }
        #colorElement .selectors .selector {
          position: absolute;
          top: 0; left: 0;
          box-sizing: border-box;
          border: thin solid currentColor;
          padding: 3px;
        }
        #colorElement .selectors .selector:focus {
          outline: none;
          border-color: var(--input-focus-color);
          background: var(--input-focus-background);
        }
        #colorElement .selectors #pin {
          border-radius: 50%;
        }
        #colorElement .selectors .slider {
          width: 100%;
          border-radius: 2px;
        }
        #colorElement #saturation {
          cursor: crosshair;
          margin-left: var(--color-element-margin);
        }
        #colorElement #alpha,
        #colorElement #hue {
          cursor: -webkit-grab;
          cursor: grab;
        }
        #colorElement #alpha.grabbing,
        #colorElement #hue.grabbing {
          cursor: -webkit-grabbing;
          cursor: grabbing;
        }
        #colorElement .lower {
          display: inline-flex;
          flex-direction: row;
          flex-wrap: wrap;
          align-self: stretch;
          overflow: hidden;
        }
        #colorElement .lower > * {
          display: inline-flex;
          flex-direction: row;
          position: relative;
          border-radius: 0 !important;
          box-shadow: none !important;
          padding: 0 !important;
        }
        #colorElement #switches {
          align-self: stretch;
          align-items: center;
          flex: 1 0 1px;
        }
        #colorElement #formats {
          align-self: stretch;
        }
        #colorElement text-input {
          margin-left: 0.4em;
          align-self: stretch;
        }
        #colorElement .field {
          display: flex;
          flex-direction: column;
          align-items: center;
        }
        #colorElement .field > .icon {
          padding-top: 4px;
          padding-bottom: 4px;
        }
        #colorElement #buttons {
          align-items: flex-end;
          align-self: flex-end;
          flex: 0 0 1px;
        }
        #colorElement #tip {
          position: absolute;
          top: 0; left: 0;
        }
        #colorElement #badge {
          border-radius: 50%;
        }
      `;
    }

    static get colorElementTemplate() {
      return `
        <div id="colorElement">
          <div class="selectors">
            ${this.colorBadgeTemplate}
          </div>
          <div class="lower">
            <div id="switches">
              ${this.colorInputTemplate}
            </div>
            <div id="buttons">
              ${this._buttonTemplate}
            <div>
          </div>
        </div>
      `
    }

    static get colorBadgeTemplate() {
      return `
        <div id="tip">
          ${super.colorBadgeTemplate}
        </div>
        <div>
          <canvas id="saturation" width="208" height="184" on-mousedown="_grabStart" on-touchstart="_grabStart"></canvas>
          <div class="selector" id="pin" tabindex="0"></div>
        </div>
        <div class="transparency">
          <canvas id="alpha" width="16" height="184" on-mousedown="_grabStart" on-touchstart="_grabStart"></canvas>
          <div class="selector slider" id="alphaSlider" tabindex="0"></div>
        </div>
        <div>
          <canvas id="hue" width="16" height="184" on-mousedown="_grabStart" on-touchstart="_grabStart"></canvas>
          <div class="selector slider" id="hueSlider" tabindex="0"></div>
        </div>
      `;
    }

    static get colorInputTemplate() {
      return `
        <template is="dom-if" if="[[_equals(format, 'hex')]]" restamp>
          <text-input id="valueInput" default="{{default}}" value="{{value}}" pattern="[[_hexPatternString]]" placeholder="#000" minlength="7"></text-input>
        </template>
        <template is="dom-if" if="[[_equals(format, 'rgb')]]" restamp>
          <label>r:</label>
          <div class="field">
            <button class="icon switch" prop="r" step="1">${this._iconStepUpTemplate}</button>
            <integer-input title="red" placeholder="0" value="{{r}}" min="0" max="255" minlength="3"></integer-input>
            <button class="icon switch" prop="r" step="-1">${this._iconStepDownTemplate}</button>
          </div>
          <label>g:</label>
          <div class="field">
            <button class="icon switch" prop="g" step="1">${this._iconStepUpTemplate}</button>
            <integer-input title="green" placeholder="0" value="{{g}}" min="0" max="255" minlength="3"></integer-input>
            <button class="icon switch" prop="g" step="-1">${this._iconStepDownTemplate}</button>
          </div>
          <label>b:</label>
          <div class="field">
            <button class="icon switch" prop="b" step="1">${this._iconStepUpTemplate}</button>
            <integer-input title="blue" placeholder="0" value="{{b}}" min="0" max="255" minlength="3"></integer-input>
            <button class="icon switch" prop="b" step="-1">${this._iconStepDownTemplate}</button>
          </div>
          <label>a:</label>
          <div class="field">
            <button class="icon switch" prop="alpha" step="0.01">${this._iconStepUpTemplate}</button>
            <number-input title="alpha" value="{{alpha}}" default="1" min="0" max="1" saturate no-clamp placeholder="1.00" start-at="1" step="0.01" minlength="3.5"></number-input>
            <button class="icon switch" prop="alpha" step="-0.01">${this._iconStepDownTemplate}</button>
          </div>
        </template>
        <template is="dom-if" if="[[_equals(format, 'hsl')]]" restamp>
          <label>h:</label>
          <div class="field">
            <button class="icon switch" prop="h" step="1">${this._iconStepUpTemplate}</button>
            <number-input title="hue" placeholder="0" min="0" max="359" minlength="3" step="[[_hslStep]]" value="{{h}}"></number-input>
            <button class="icon switch" prop="h" step="-1">${this._iconStepDownTemplate}</button>
          </div>
          <label>s:</label>
          <div class="field">
            <button class="icon switch" prop="s" step="0.01">${this._iconStepUpTemplate}</button>
            <number-input title="saturation" placeholder="100\u202F%" minlength="2.5" in-percent saturate min="0" max="1" step="[[_hslPercentStep]]" start-at="1" value="{{s}}"></number-input>
            <button class="icon switch" prop="s" step="-0.01">${this._iconStepDownTemplate}</button>
          </div>
          <label>l:</label>
          <div class="field">
            <button class="icon switch" prop="l" step="0.01">${this._iconStepUpTemplate}</button>
            <number-input title="lightness" placeholder="100\u202F%" minlength="2.5" in-percent saturate min="0" max="1" step="[[_hslPercentStep]]" start-at="0.5" value="{{l}}"></number-input>
            <button class="icon switch" prop="l" step="-0.01">${this._iconStepDownTemplate}</button>
          </div>
          <label>a:</label>
          <div class="field">
            <button class="icon switch" prop="alpha" step="0.01">${this._iconStepUpTemplate}</button>
            <number-input title="alpha" value="{{alpha}}" default="1" min="0" max="1" saturate no-clamp placeholder="1.00" start-at="1" step="0.01" minlength="3.5"></number-input>
            <button class="icon switch" prop="alpha" step="-0.01">${this._iconStepDownTemplate}</button>
          </div>
        </template>
      `
    }

    /**
     * template for control buttons
     * @type {string}
     */
    static get _buttonTemplate() {
      return `
        <select id="formats" value="{{format::change}}">
          <option value="rgb">rgb</option>
          <option value="hex">hex</option>
          <option value="hsl">hsl</option>
        </select>
        <button class="icon random" on-click="random"><svg viewBox="0 0 24 24"><g><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></g></svg></button>
        ${super._buttonTemplate || ''}
      `;
    }

    static get properties() {
      return {
        /**
         * width of the badge in pixels
         * @type {number}
         */
        width: {
          type: Number,
          value: 24
        },
        /**
         * height of the badge in pixels
         * @type {number}
         */
        height: {
          type: Number,
          value: 24
        },
      };
    }

    static get observers() {
      return [

      ];
    }

    _drawBadge(value) {
      super._drawBadge(value);
      // if (this._context === undefined) {
      //   this._context = this.$.badge.getContext("2d");
      // }
      // this._context.clearRect(0, 0, this.width, this.height);
      // this._context.fillStyle = value || 'rgba(0,0,0,0)';
      // this._context.fillRect(0, 0, this.width, this.height);
    }

    /**
     * renderColors the current view (manually).
     */
    _drawSelector(h, s, l) {
      let context = this.$.saturation.getContext("2d");
      let rect = this.$.saturation.getBoundingClientRect();

      let width = rect.width;
      let height = rect.height;

      context.clearRect(0, 0, width, height);

      let gradient = context.createLinearGradient(0, 0, width, 1);
      gradient.addColorStop(0, 'hsl(0,100%,100%)');
      gradient.addColorStop(1, `hsl(${h},100%,50%)`);

      context.fillStyle = gradient;
      context.fillRect(0, 0, width, height);

      gradient = context.createLinearGradient(0, 0, 1, height);
      gradient.addColorStop(0, 'rgba(0,0,0,0)');
      gradient.addColorStop(1, 'rgba(0,0,0,1)');

      context.fillStyle = gradient;
      context.fillRect(0, 0, width, height);
      const x = width * s,
       y = height * (1 - l);
      this._drawCircle(context, x, y);
    }

    _drawCircle(context, x, y) {
      context.beginPath();
      context.arc(x, y, 3, 0, 2*Math.PI);
      context.closePath();
      context.lineWidth = 1.5;
      context.strokeStyle = '#fff';
      context.stroke();
    }

    _fillRect(elem, value) {
      const context = elem.getContext("2d"),
        rect = elem.getBoundingClientRect(),
        width = rect.width,
        height = rect.height;

      context.clearRect(0, 0, width, height);
      context.fillStyle = value;
      context.fillRect(0, 0, width, height);
    }

    _drawHue(h, s, l) {
      let context = this.$.hue.getContext("2d");
      let rect = this.$.hue.getBoundingClientRect();

      let width = rect.width;
      let height = rect.height;

      context.clearRect(0, 0, width, height);

      let gradient = context.createLinearGradient(0, 0, 1, height);

      for (let step = 0; step < 360; step += 30) {
        gradient.addColorStop(step/360, `hsl(${step},100%,50%)`);
      }
      gradient.addColorStop(1, `hsl(0,100%,50%)`);
      context.fillStyle = gradient;
      context.fillRect(0, 0, width, height);

      const y = height * h / 360;
      this._drawSlider(context, width, y);
    }

    _drawAlpha(h, alpha) {

      let context = this.$.alpha.getContext("2d");
      let rect = this.$.alpha.getBoundingClientRect();

      let width = rect.width;
      let height = rect.height;

      context.clearRect(0, 0, width, height);

      let gradient = context.createLinearGradient(0, 0, 1, height);
      gradient.addColorStop(0, `hsl(${h},100%,50%)`);
      gradient.addColorStop(1, 'rgba(0,0,0,0)');
      context.fillStyle = gradient;
      context.fillRect(0, 0, width, height);
      const y = (1 - alpha) * height;
      this._drawSlider(context, width, y);
      this.alpha = alpha;
    }

    _drawSlider(context, width, y) {
      context.beginPath();
      y -= 2;
      context.moveTo(0, y);
      context.lineTo(width, y);
      y += 3;
      context.moveTo(0, y);
      context.lineTo(width, y);
      context.closePath();
      context.lineWidth = 1.5;
      context.strokeStyle = '#fff';
      context.stroke();
    }

    _fixColor() {
      console.log('_fixColor', this._selectedHsv);
      if (this._selectedHsv) {
        const rgb = this.hsvToRgb(this._selectedHsv);
        if (this._arrayEqual(this.rgb, rgb) === false) {
          this.set('rgb', rgb);
          this._drawSelectedColor(this.hsv, this.alpha);
          this._drawSaturation(this.hsv);
        }
        this.close();
      }
    }

    _resetColor() {
      if (!(Array.isArray(this.hsv) && this.hsv.length === 3)) {
        return;
      }
      this._drawSelectedColor(this.hsv, this.alpha);
      this._drawSaturation(this.hsv);
    }

    _grabStart(e) {
      if (!(e && e.target)) {
        return;
      }
      e.target.classList.add('grabbing');
      e.target.addEventListener('mousemove', this._select.bind(this), {capture: false, passive: true});
      e.target.addEventListener('touchmove', this._select.bind(this), {capture: false, passive: true});
      e.target.addEventListener('mouseup', this._grabEnd.bind(this), {capture: false, passive: true});
      e.target.addEventListener('mouseleave', this._grabEnd.bind(this), {capture: false, passive: true});
      e.target.addEventListener('touchend', this._grabEnd.bind(this), {capture: false, passive: true});
      this._select(e);
    }

    _grabEnd(e) {
      if (!(e && e.target)) {
        return;
      }
      this._select(e);
      e.target.classList.remove('grabbing');
      e.target.removeEventListener('mousemove', this._select.bind(this), {capture: false, passive: true});
      e.target.removeEventListener('touchmove', this._select.bind(this), {capture: false, passive: true});
      e.target.removeEventListener('mouseup', this._grabEnd.bind(this), {capture: false, passive: true});
      e.target.removeEventListener('mouseleave', this._grabEnd.bind(this), {capture: false, passive: true});
      e.target.removeEventListener('touchend', this._grabEnd.bind(this), {capture: false, passive: true});
    }

    _select(e) {
      if (!(e && e.target && e.target.classList.contains('grabbing'))) {
        return;
      } else if (e && e.type) {
        e.target.removeEventListener(e.type, this._select.bind(this), {capture: false, passive: true});
      }

      const rect = e.target.getBoundingClientRect(),
      width = rect.width,
      height = rect.height,
      elemLeft = rect.left,
      elemTop = rect.top,
      property = e.target.getAttribute('id');
      const hsv = [];
      for (let i = 0; i < this._selectedHsv.length; i++) {
        hsv.push(this._selectedHsv[i] || 0);
      }
      let alpha = this.alpha;
      switch (property) {
        case 'alpha':
          alpha = +(1 - (e.clientY - elemTop) / height).toFixed(2);
          alpha = (alpha >= 0 && alpha <= 1) ? alpha : (this.alpha || 1);
          break;
        case 'saturation':
          s = +(((e.clientX - elemLeft) / width).toFixed(3));
          s = s > 1 ? 1 : s;
          s = s < 0 ? 0 : s;
          l = +((1 - (e.clientY - elemTop) / height).toFixed(3));
          l = l > 1 ? 1 : l;
          l = l < 0 ? 0 : l;
          this._drawHue(h, s, l);
          this._drawSelector(h, s, l);
          break;
        case 'hue':
          h = Math.round(360 * (e.clientY - elemTop) / height);
          h = h > 360 ? 360 : h;
          h = h < 0 ? 0 : h;
          this._drawHue(h, s, l);
          this._drawSelector(h, s, l);
          break;
      }
      this.set('_selectedHsv', hsv);
      this.alpha = alpha;
      this._drawAlpha(h, alpha);
    }

    _onContextMenu(e) {
      if (e && e.preventDefault) {
        e.preventDefault();
      }
      this.random()
    }
  }
</script>

<dom-module id="color-element">
  <script>
  /**
  * `<color-element>` adds a color selector to your page using Polymer.
  *
  *   ```html
  *     <color-element value="{{color}}"></color-element>
  *   ```
  *
  * For example if you clamp on `hours`, you can round `color` and `value` to `00:00:00`. If you set `clamp="day"` you hide the day-selection.
  *
  * The following custom properties and mixins are also available for styling:
  *
  * Custom property | Description | Default
  * ----------------|-------------|----------
  * `--color-element-margin` | margin of the single color-element | `0px`
  * `--color-element-background` | background-color of the color-element | `#f0f0f0`
  *
  * @customElement
  * @polymer
  *
  * @appliesMixin ColorElementPattern
  *
  * @demo demo/color-picker.html
  **/
    class ColorElement extends ColorElementPattern(Polymer.Element) { // eslint-disable-line no-undef

      static get is() {
        return 'color-element';
      }

      static get template() {
        return `
          ${this.styleTemplate}
          ${this.colorElementTemplate}
        `
      }

    }
    window.customElements.define(ColorElement.is, ColorElement);
  </script>
</dom-module>
